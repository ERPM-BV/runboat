<html>
    <head>
        <title>Runboat builds</title>
        <style>
            body {
                font-family: Arial, Helvetica, sans-serif;
            }
            .row {
                display: flex;
                flex-direction: row;
                border-style: none none solid none;
                border-width: thin;
                border-color: lightgray;
            }
            runboat-build {
                margin: 0.25em;
            }
            #footer {
                color: gray;
                font-size: small;
            }
        </style>
    </head>
    <body>
        <div id="builds"></div>
        <div id="footer">
            <p>Runboat - Created with love for <a href="https://odoo-community.org"><img src="https://odoo-community.org/logo.png" style="height: 1em; vertical-align: text-top;"></a> by Stéphane Bidoul with support of <a href="https://acsone.eu"><img src="https://acsone.eu/logo.png" style="height: 1em; vertical-align:   text-top;"></a>. Copyright © Runboat <a href="https://github.com/sbidoul/runboat/graphs/contributors">contributors</a>.</p>
        </div>
        <script type="module">
            import {RunboatBuildElement} from './runboat-build-element.js'
            customElements.define('runboat-build', RunboatBuildElement);

            const repo = new URLSearchParams(window.location.search).get("repo");
            const target_branch = new URLSearchParams(window.location.search).get("target_branch");
            var url = `/api/v1/build-events?repo=${repo}`
            if (target_branch) {
                url += `&target_branch=${target_branch}`
            }
            // TODO: evtSource error handling
            const evtSource = new EventSource(url);
            evtSource.onmessage = function(event) {
                var oEvent = JSON.parse(event.data);
                var buildElement = document.getElementById(oEvent.build.name);
                if (oEvent.event == "upd") {
                    if (buildElement) {
                        // update event element
                        buildElement.build = oEvent.build;
                    } else {
                        var rowId = `branch-${oEvent.build.target_branch}`;
                        if (oEvent.build.pr) {
                            rowId += `-pr-${oEvent.build.pr}`
                        }
                        var rowElement = document.getElementById(rowId);
                        if (!rowElement) {
                            // create row
                            rowElement = document.createElement("div");
                            rowElement.classList.add("row");
                            rowElement.id = rowId;
                            const buildsElement = document.getElementById("builds");
                            buildsElement.insertBefore(rowElement, buildsElement.firstChild);
                        }
                        // add build element to row
                        buildElement = document.createElement("runboat-build");
                        buildElement.id = oEvent.build.name;
                        buildElement.build = oEvent.build;
                        rowElement.insertBefore(buildElement, rowElement.firstChild);
                    }
                } else if (oEvent.event == "del") {
                    if (buildElement) {
                        buildElement.remove();
                    }
                }
            }
        </script>
    </body>
</html>
